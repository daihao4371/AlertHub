name: Test CI

on:
  push:
    branches:
      - master
      - main
      - dev
    tags:
      - v*
  pull_request:
    branches:
      - master
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Check ACR credentials
        id: check_acr
        run: |
          if [ -n "${{ secrets.ALIYUN_ACR_USER }}" ] && [ -n "${{ secrets.ALIYUN_ACR_PASSWORD }}" ]; then
            echo "has_creds=true" >> $GITHUB_OUTPUT
          else
            echo "has_creds=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract version info
        id: version
        run: |
          if [[ "${GITHUB_REF}" =~ ^refs/tags/ ]]; then
            # Tagæ¨é€
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "is_tag=true" >> $GITHUB_OUTPUT
            echo "version=${TAG_NAME}" >> $GITHUB_OUTPUT
            echo "âœ… Tagæ¨é€: ${TAG_NAME}"

            # éªŒè¯tagæ ¼å¼
            if [[ ! "${TAG_NAME}" =~ ^v[0-9] ]]; then
              echo "âŒ é”™è¯¯: tagæ ¼å¼ä¸å¯¹: ${TAG_NAME}"
              exit 1
            fi
          else
            # åˆ†æ”¯æ¨é€
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "version=${BRANCH_NAME}" >> $GITHUB_OUTPUT
            echo "âœ… åˆ†æ”¯æ¨é€: ${BRANCH_NAME}"
          fi

      - name: Login to Aliyun Container Registry
        if: steps.check_acr.outputs.has_creds == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_ACR_REGISTRY || 'registry.cn-hangzhou.aliyuncs.com' }}
          username: ${{ secrets.ALIYUN_ACR_USER }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}

      - name: Prepare image tags
        id: image_tags
        run: |
          REGISTRY="${{ secrets.ALIYUN_ACR_REGISTRY || 'registry.cn-hangzhou.aliyuncs.com' }}"
          NAMESPACE="${{ secrets.ALIYUN_ACR_NAMESPACE || 'devops-dh' }}"
          REPO="alerthub"
          VERSION="${{ steps.version.outputs.version }}"

          IMAGE_TAG="${REGISTRY}/${NAMESPACE}/${REPO}:${VERSION}"

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${IMAGE_TAG}"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: false
          provenance: false
          sbom: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          tags: |
            ${{ steps.image_tags.outputs.image_tag }}