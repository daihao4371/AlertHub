# Default values for watchalert.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

imagePullSecrets: []
imagePullPolicy: IfNotPresent

service:
  image:
    repository: registry.cn-hangzhou.aliyuncs.com/devops-dh/alerthub
    tag: "latest"

  resources:
    requests:
      memory: 256Mi
      cpu: 500m
    limits:
      memory: 2Gi
      cpu: 2

  config: |-
    Server:
      port: "9001"
      mode: "release"
    
    MySQL:
      host: 10.10.217.225
      port: 3306
      user: root
      pass: 123456
      dbName: alerthub
      timeout: 10s
    
    Redis:
      host: 10.10.217.225
      port: 6379
      pass: ""
      database: 0
    
    Jwt:
      expire: 18000
    
#    Ldap:
#      enabled: false
#      address: "192.168.1.100:399"
#      baseDN: "dc=test,dc=com"
#      adminUser: "cn=admin,dc=test,dc=com"
#      adminPass: "test123."
#      userDN: "ou=people,dc=test,dc=com"
#      userPrefix: "uid"
#      defaultUserRole: "ur-cq7nkj1d6gviooaigqi0"
#      cronjob: "*/1 * * * *"
#
  nodeSelector: {}

  tolerations: []

  livenessProbe:
    httpGet:
      path: /hello
      port: 9001
    initialDelaySeconds: 10
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /hello
      port: 9001
    initialDelaySeconds: 5
    periodSeconds: 10

  # 后端服务的 NodePort 配置
  # nodePort: 30001  # 取消注释以指定具体的 NodePort 端口号

  # 后端服务的 Ingress 配置
  ingress:
    enabled: false
    className: nginx
    annotations:
      nginx.ingress.kubernetes.io/proxy-body-size: "2050m"
      nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    hosts:
      - host: alerthub-api.x.com
        paths:
          - path: /
            pathType: Prefix
    tls: []

web:
  image:
    repository: registry.cn-hangzhou.aliyuncs.com/devops-dh/alerthub-web
    tag: "latest"

  resources:
    requests:
      memory: 256Mi
      cpu: 256m
    limits:
      memory: 2Gi
      cpu: 2

  livenessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 10
    periodSeconds: 10

  readinessProbe:
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 5
    periodSeconds: 10

  config: |-
    server {
      listen 80;

      root /usr/share/nginx/html;
      index index.html index.htm;
    
      location / {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        try_files $uri $uri/ /index.html;
      }
    
      # SSE 流式传输专用配置（AI 聊天接口）
      location /api/w8t/ai/chat {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';

        # SSE 关键配置：禁用所有缓冲
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;

        # 使用 HTTP/1.1 支持长连接
        proxy_http_version 1.1;
        proxy_set_header Connection '';

        # 超时设置（SSE 需要较长超时）
        proxy_connect_timeout 300;
        proxy_read_timeout 600;
        proxy_send_timeout 600;

        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2;
        proxy_pass http://{{ include "alerthub.componentName" (dict "root" . "component" "service") }}:9001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_body $request_body;
        proxy_pass_request_headers on;
      }

      # 其他 API 接口
      location /api {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        proxy_connect_timeout 300;
        proxy_read_timeout 300;
        proxy_send_timeout 300;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_request_buffering off;
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2;
        proxy_pass http://{{ include "alerthub.componentName" (dict "root" . "component" "service") }}:9001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_body $request_body;
        proxy_pass_request_headers on;
      }
    
      error_page 500 502 503 504 /500.html;
    
      client_max_body_size 2050m;
      client_body_buffer_size 1024k;
    
      keepalive_timeout 10;
    }

  service:
    type: NodePort
#    nodePort: 30080

  ingress:
    enabled: true
    className: nginx
    annotations:
      nginx.ingress.kubernetes.io/rewrite-target: /
      nginx.ingress.kubernetes.io/proxy-body-size: "2050m"
      # SSE 流式传输必需配置
      nginx.ingress.kubernetes.io/proxy-buffering: "off"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
      nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    hosts:
      - host: alerthub.x.com
        paths:
          - path: /
            pathType: Prefix
    tls: []

serviceAccount:
  create: false
  annotations: {}
  name: ""

job:
  # 是否启用初始化 Job (用于导入 SQL 数据)
  enabled: true

  image:
    repository: docker.1ms.run/mysql
    tag: "8.0"

  mysql:
    host: "10.10.217.225"
    username: root
    password: 123456
    database: alerthub

  # SQL 导入开关控制 (1 表示导入, 0 表示跳过)
  imports:
    noticeTemplate: "1"
    ruleTemplateGroups: "1"
    ruleTemplates: "1"
    tenants: "1"
    tenantsLinkedUsers: "1"

mysql:
  enabled:  false

  image:
    repository: docker.1ms.run/mysql
    tag: "8.0"

  auth:
    password: 123456
    database: alerthub

  # 指定 MySQL Pod 的调度节点（示例：{"kubernetes.io/hostname": "node-name"}）
  nodeSelector: {}
  tolerations: []

  persistence:
    enabled:  false
    storageClass: "hostpath"
    accessModes: "ReadWriteOnce"
    size: 5Gi

redis:
  enabled:  false

  image:
    repository: docker.1ms.run/redis
    tag: "latest"

  persistence:
    enabled:  false
    storageClass: "hostpath"
    accessModes: "ReadWriteOnce"
    size: 1Gi

  # 指定 Redis Pod 的调度节点（示例：{"kubernetes.io/hostname": "node-name"}）
  nodeSelector: {}
  tolerations: []

initContainers:
  wait:
    image:
      repository: docker.1ms.run/busybox
      tag: "1.36.1"
